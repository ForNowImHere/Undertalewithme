<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Remote Window Viewer</title>
  <style>
    body { margin:0; background:#000; color:#ddd; font-family:sans-serif;
           display:flex; flex-direction:column; align-items:center; }
    canvas { border:2px solid #333; margin-top:10px; }
    #status { margin-top:6px; }
    #connectSection { margin-top: 20px; }
  </style>
</head>
<body>
  <h2>Remote Window Viewer</h2>
  <div id="connectSection">
    <label for="codeInput">Enter access code:</label>
    <input id="codeInput" type="text" maxlength="6" />
    <button id="connectBtn">Connect</button>
  </div>
  <div id="status">Waiting for code...</div>
  <canvas id="c" style="display:none;"></canvas>

  <script>
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d');
    const status = msg => document.getElementById('status').textContent = msg;

    let ws = null;
    let interactive = false;

    document.getElementById('connectBtn').onclick = () => {
      const code = document.getElementById('codeInput').value.trim().toLowerCase();
      if(code.length !== 6){
        status("âŒ Code must be 6 characters");
        return;
      }
      status("Looking up server...");
      fetch(`/lookup/${code}`).then(res => {
        if(!res.ok) throw new Error("Code not found");
        return res.json();
      }).then(({ip, port}) => {
        status(`Connecting to ${ip}:${port} ...`);
        connectWS(ip, port, code);
      }).catch(e => {
        status("âŒ " + e.message);
      });
    };

    function connectWS(ip, port, code) {
      ws = new WebSocket(`ws://${ip}:${port}/ws`);

      ws.onopen = () => {
        ws.send(JSON.stringify({tag:'hello', code}));
      };

      ws.onmessage = ev => {
        const msg = JSON.parse(ev.data);
        if(msg.tag === 'error'){
          status("âŒ "+msg.msg);
          ws.close();
          return;
        }
        if(msg.tag === 'role'){
          interactive = msg.interactive;
          status(interactive ? 'ðŸ•¹ Control granted' : 'ðŸ‘ View-only');
          canvas.style.display = 'block';
        }
        if(msg.tag === 'frame'){
          const img = new Image();
          img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img,0,0);
          };
          img.src = 'data:image/jpeg;base64,' + msg.data;
        }
      };

      ws.onclose = () => {
        status("Disconnected");
        canvas.style.display = 'none';
      };

      function send(tag, data){
        if(ws && ws.readyState === 1){
          ws.send(JSON.stringify({tag, data}));
        }
      }

      canvas.onmousedown = e => {
        if(!interactive) return;
        const r = canvas.getBoundingClientRect();
        send('mouse', {x: e.clientX - r.left, y: e.clientY - r.top, button: e.button, event: 'down'});
      };
      canvas.onmouseup = e => {
        if(!interactive) return;
        const r = canvas.getBoundingClientRect();
        send('mouse', {x: e.clientX - r.left, y: e.clientY - r.top, button: e.button, event: 'up'});
      };
      canvas.onmousemove = e => {
        if(!interactive) return;
        const r = canvas.getBoundingClientRect();
        send('mouse', {x: e.clientX - r.left, y: e.clientY - r.top, button: e.button, event: 'move'});
      };

      window.onkeydown = e => {
        if(interactive) send('key', {key: e.key, event: 'down'});
      };
      window.onkeyup = e => {
        if(interactive) send('key', {key: e.key, event: 'up'});
      };
    }
  </script>
</body>
</html>
